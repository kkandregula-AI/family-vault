<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#0d1b2a">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="FamilyVault">
<title>Family Vault</title>
<link rel="manifest" href="manifest.json">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&family=Nunito:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:        #0d1b2a;
  --bg2:       #112236;
  --surface:   #162d45;
  --card:      #1a344f;
  --card2:     #1f3d5c;
  --border:    rgba(255,255,255,0.07);
  --border2:   rgba(255,255,255,0.13);
  --gold:      #c8973f;
  --gold2:     #e8b85a;
  --gold-d:    rgba(200,151,63,0.13);
  --teal:      #38b2ac;
  --teal-d:    rgba(56,178,172,0.13);
  --rose:      #e05252;
  --rose-d:    rgba(224,82,82,0.13);
  --amber:     #dd8c2f;
  --amber-d:   rgba(221,140,47,0.13);
  --sky:       #4a9fd4;
  --sky-d:     rgba(74,159,212,0.13);
  --green:     #48bb78;
  --green-d:   rgba(72,187,120,0.13);
  --violet:    #9f7aea;
  --violet-d:  rgba(159,122,234,0.13);
  --text:      #e2eaf4;
  --text2:     #8fa8c2;
  --text3:     #4d6a85;
  --nav-h:     62px;
  --safe-b:    env(safe-area-inset-bottom,0px);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{font-family:'Nunito',sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}

/* â”€â”€ LOCK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#lock{
  position:fixed;inset:0;z-index:9999;
  background:var(--bg);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:2rem;
  background-image:
    radial-gradient(ellipse 100% 60% at 50% 0%,rgba(200,151,63,.1) 0%,transparent 55%),
    radial-gradient(ellipse 70% 50% at 90% 100%,rgba(56,178,172,.07) 0%,transparent 50%);
}
.lock-emblem{
  width:88px;height:88px;border-radius:22px;
  background:linear-gradient(145deg,var(--card),var(--surface));
  border:1px solid rgba(200,151,63,.3);
  display:flex;align-items:center;justify-content:center;
  font-size:2.4rem;margin-bottom:1.2rem;
  box-shadow:0 0 60px rgba(200,151,63,.12);
  animation:glow 4s ease-in-out infinite;
}
@keyframes glow{0%,100%{box-shadow:0 0 40px rgba(200,151,63,.08)}50%{box-shadow:0 0 80px rgba(200,151,63,.22)}}
.lock-title{font-family:'Libre Baskerville',serif;font-size:1.9rem;color:var(--gold2);letter-spacing:.04em;margin-bottom:.3rem;text-align:center}
.lock-sub{font-size:.78rem;color:var(--text3);text-transform:uppercase;letter-spacing:.1em;text-align:center;margin-bottom:2rem}
.pin-row{display:flex;gap:.75rem;margin-bottom:1.5rem;justify-content:center}
.pin-dot{width:13px;height:13px;border-radius:50%;border:2px solid var(--text3);background:transparent;transition:all .15s}
.pin-dot.on{background:var(--gold);border-color:var(--gold)}
.numpad{display:grid;grid-template-columns:repeat(3,70px);gap:.65rem;justify-content:center}
.nk{
  width:70px;height:70px;border-radius:50%;
  background:var(--card);border:1px solid var(--border2);
  color:var(--text);font-family:'Nunito',sans-serif;font-size:1.35rem;font-weight:600;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  -webkit-tap-highlight-color:transparent;user-select:none;transition:all .1s;
}
.nk:active{background:var(--card2);transform:scale(.93)}
.nk.act{font-size:.95rem;color:var(--text2)}
.nk.ok{background:var(--gold);color:#0d1b2a;border-color:var(--gold);font-size:1.2rem}
.nk.ok:active{background:var(--gold2)}
.nk:disabled{opacity:.25;cursor:default}
.lock-err{height:1.2rem;font-size:.8rem;color:var(--rose);text-align:center;margin-bottom:.75rem}
.lock-hint{font-size:.76rem;color:var(--text3);text-align:center;margin-top:1.4rem}

/* â”€â”€ APP SHELL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#app{display:none;height:100dvh;flex-direction:column;overflow:hidden}
#app.on{display:flex}

.topbar{
  flex-shrink:0;height:58px;
  background:var(--bg2);border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
  padding:0 1rem;padding-top:env(safe-area-inset-top,0px);
  gap:.5rem;
}
.topbar-brand{font-family:'Libre Baskerville',serif;font-size:1.2rem;color:var(--gold2);letter-spacing:.04em;flex:1}
.topbar-sync{
  display:flex;align-items:center;gap:.35rem;
  padding:.3rem .7rem;border-radius:20px;
  font-size:.72rem;font-weight:700;
  cursor:pointer;border:none;font-family:'Nunito',sans-serif;
  -webkit-tap-highlight-color:transparent;transition:all .2s;
}
.sync-idle   {background:var(--green-d);color:var(--green);border:1px solid rgba(72,187,120,.25)}
.sync-ing    {background:var(--sky-d);color:var(--sky);border:1px solid rgba(74,159,212,.25);animation:pulse-border 1.2s ease-in-out infinite}
.sync-error  {background:var(--rose-d);color:var(--rose);border:1px solid rgba(224,82,82,.25)}
.sync-noauth {background:var(--amber-d);color:var(--amber);border:1px solid rgba(221,140,47,.25)}
@keyframes pulse-border{0%,100%{opacity:1}50%{opacity:.6}}
.ib{
  width:34px;height:34px;border-radius:9px;
  background:var(--card);border:1px solid var(--border);
  color:var(--text2);font-size:.95rem;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  -webkit-tap-highlight-color:transparent;transition:all .15s;
}
.ib:active{background:var(--card2)}

.content{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding-bottom:calc(var(--nav-h) + var(--safe-b) + .5rem)}

.bottomnav{
  flex-shrink:0;height:calc(var(--nav-h) + var(--safe-b));
  padding-bottom:var(--safe-b);
  background:var(--bg2);border-top:1px solid var(--border);
  display:flex;align-items:flex-start;
}
.ni{
  flex:1;height:var(--nav-h);display:flex;flex-direction:column;
  align-items:center;justify-content:center;gap:.2rem;
  cursor:pointer;color:var(--text3);
  font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;
  -webkit-tap-highlight-color:transparent;transition:color .2s;
  border:none;background:none;
}
.ni .ico{font-size:1.25rem;transition:transform .2s}
.ni.on{color:var(--gold)}
.ni.on .ico{transform:translateY(-2px)}

/* â”€â”€ VIEWS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.view{display:none;padding:1.1rem;animation:fu .2s ease}
.view.on{display:block}
@keyframes fu{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

.sec-title{font-size:.68rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:.65rem;margin-top:.1rem}

/* â”€â”€ HOME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.hero{
  background:linear-gradient(135deg,var(--card),var(--card2));
  border:1px solid var(--border2);border-radius:16px;
  padding:1.2rem;margin-bottom:1rem;position:relative;overflow:hidden;
}
.hero::before{content:'ğŸ—„ï¸';position:absolute;right:-1rem;top:50%;transform:translateY(-50%);font-size:6rem;opacity:.05;pointer-events:none}
.hero h2{font-family:'Libre Baskerville',serif;font-size:1.2rem;color:var(--gold2);margin-bottom:.25rem}
.hero p{font-size:.8rem;color:var(--text2)}
.gdrive-status{
  display:flex;align-items:center;gap:.5rem;
  margin-top:.8rem;padding:.5rem .75rem;
  border-radius:8px;font-size:.78rem;font-weight:600;
  width:fit-content;
}
.gds-conn  {background:var(--green-d);color:var(--green)}
.gds-disc  {background:var(--amber-d);color:var(--amber);cursor:pointer}

.s4{display:grid;grid-template-columns:1fr 1fr;gap:.65rem;margin-bottom:1rem}
.tile{
  background:var(--card);border:1px solid var(--border);
  border-radius:13px;padding:.9rem;display:flex;align-items:center;gap:.8rem;
}
.tile .ico2{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.05rem;flex-shrink:0}
.tl{font-size:.68rem;color:var(--text3);font-weight:600;margin-bottom:.1rem}
.tv{font-size:1.45rem;font-weight:700;font-family:'Libre Baskerville',serif;color:var(--text)}

.alert-list{display:flex;flex-direction:column;gap:.5rem;margin-bottom:.9rem}
.al{
  background:var(--card);border:1px solid var(--border);
  border-radius:12px;padding:.7rem .9rem;
  display:flex;align-items:center;gap:.7rem;cursor:pointer;
}
.al.exp{border-color:rgba(224,82,82,.3);background:rgba(224,82,82,.06)}
.al.warn{border-color:rgba(221,140,47,.3);background:rgba(221,140,47,.06)}
.al-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.al-dot.exp{background:var(--rose)}.al-dot.warn{background:var(--amber)}
.al-name{font-size:.86rem;font-weight:600;flex:1}
.al-sub{font-size:.7rem;color:var(--text3)}
.badge{font-size:.62rem;font-weight:700;padding:.18rem .5rem;border-radius:20px;text-transform:uppercase;letter-spacing:.04em}
.badge.exp{background:var(--rose-d);color:var(--rose)}
.badge.warn{background:var(--amber-d);color:var(--amber)}

.type-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.55rem;margin-bottom:1rem}
.type-tile{
  background:var(--card);border:1px solid var(--border);
  border-radius:12px;padding:.75rem .5rem;
  display:flex;flex-direction:column;align-items:center;gap:.3rem;
  cursor:pointer;-webkit-tap-highlight-color:transparent;transition:all .15s;
}
.type-tile:active{background:var(--card2)}
.type-tile .ti{font-size:1.5rem}
.type-tile .tn{font-size:.65rem;color:var(--text2);font-weight:600;text-align:center}
.type-tile .tc{font-size:1.1rem;font-weight:700;font-family:'Libre Baskerville',serif;color:var(--text)}

/* â”€â”€ DOCS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.search-wrap{position:relative;margin-bottom:.7rem}
.search-wrap input{
  width:100%;background:var(--card);border:1px solid var(--border2);
  border-radius:11px;padding:.65rem 1rem .65rem 2.5rem;
  color:var(--text);font-family:'Nunito',sans-serif;font-size:.9rem;outline:none;
}
.search-wrap input::placeholder{color:var(--text3)}
.search-wrap input:focus{border-color:rgba(200,151,63,.4)}
.si{position:absolute;left:.8rem;top:50%;transform:translateY(-50%);color:var(--text3);pointer-events:none;font-size:.9rem}

.chips{display:flex;gap:.4rem;overflow-x:auto;margin-bottom:.8rem;padding-bottom:2px;scrollbar-width:none}
.chips::-webkit-scrollbar{display:none}
.chip{
  flex-shrink:0;padding:.3rem .8rem;border-radius:20px;
  background:var(--card);border:1px solid var(--border2);
  color:var(--text2);font-size:.75rem;font-weight:600;
  cursor:pointer;white-space:nowrap;-webkit-tap-highlight-color:transparent;transition:all .15s;
}
.chip.on{background:var(--gold-d);border-color:rgba(200,151,63,.4);color:var(--gold2)}

.dlist{display:flex;flex-direction:column;gap:.6rem}
.drow{
  background:var(--card);border:1px solid var(--border);
  border-radius:13px;overflow:hidden;display:flex;align-items:stretch;
  cursor:pointer;-webkit-tap-highlight-color:transparent;transition:all .15s;
}
.drow:active{background:var(--card2)}
.dbar{width:4px;flex-shrink:0}
.dbar-id{background:linear-gradient(180deg,#4a9fd4,#2d7ab5)}
.dbar-med{background:linear-gradient(180deg,#38b2ac,#228882)}
.dbar-fin{background:linear-gradient(180deg,#c8973f,#9a7030)}
.dbar-legal{background:linear-gradient(180deg,#9f7aea,#7254c0)}
.dbar-birth{background:linear-gradient(180deg,#48bb78,#2e8a52)}
.dbar-other{background:linear-gradient(180deg,#4d6a85,#2a4a62)}

.dbody{flex:1;padding:.85rem .9rem}
.dname{font-size:.92rem;font-weight:700;margin-bottom:.25rem;display:flex;align-items:center;gap:.4rem}
.dname .file-ico{font-size:.7rem;background:var(--green-d);color:var(--green);padding:.1rem .35rem;border-radius:4px;font-weight:700}
.dmeta{font-size:.72rem;color:var(--text3);display:flex;gap:.7rem;flex-wrap:wrap}
.dright{padding:.85rem .8rem .85rem 0;display:flex;flex-direction:column;align-items:flex-end;justify-content:space-between}
.epill{font-size:.62rem;font-weight:700;padding:.18rem .5rem;border-radius:20px;text-transform:uppercase;letter-spacing:.04em;white-space:nowrap}
.ep-ok   {background:var(--green-d);color:var(--green)}
.ep-soon {background:var(--amber-d);color:var(--amber)}
.ep-exp  {background:var(--rose-d);color:var(--rose)}
.ep-none {background:var(--sky-d);color:var(--sky)}
.ep-sync {background:var(--teal-d);color:var(--teal)}
.ep-nosync{background:var(--amber-d);color:var(--amber)}
.row-acts{display:flex;gap:.3rem}
.mb{
  width:27px;height:27px;border-radius:7px;
  background:var(--card2);border:1px solid var(--border);
  color:var(--text2);font-size:.72rem;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  -webkit-tap-highlight-color:transparent;transition:all .15s;
}
.mb:active{transform:scale(.88)}
.mb.del:active{background:var(--rose-d);color:var(--rose)}

.empty{text-align:center;padding:3.5rem 1rem;color:var(--text3)}
.empty .ei{font-size:3rem;margin-bottom:.75rem}
.empty h3{font-family:'Libre Baskerville',serif;font-size:1.1rem;color:var(--text2);margin-bottom:.35rem}
.empty p{font-size:.8rem}

/* â”€â”€ MEMBERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mcard{
  background:var(--card);border:1px solid var(--border);
  border-radius:14px;padding:1rem;margin-bottom:.65rem;
  display:flex;align-items:center;gap:.9rem;
}
.mav{
  width:48px;height:48px;border-radius:50%;
  background:var(--gold-d);border:2px solid rgba(200,151,63,.25);
  display:flex;align-items:center;justify-content:center;
  font-family:'Libre Baskerville',serif;font-size:1.2rem;font-weight:700;color:var(--gold2);flex-shrink:0;
}
.mname{font-size:.95rem;font-weight:700;margin-bottom:.12rem}
.mrel{font-size:.72rem;color:var(--text3)}
.mcnt{background:var(--gold-d);color:var(--gold2);font-size:.72rem;font-weight:700;padding:.22rem .6rem;border-radius:10px}

/* â”€â”€ BACKUP / SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.bcard{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:1.2rem;margin-bottom:.75rem}
.bcard h3{font-family:'Libre Baskerville',serif;font-size:1.05rem;color:var(--gold2);margin-bottom:.35rem}
.bcard p{font-size:.8rem;color:var(--text2);line-height:1.55;margin-bottom:.9rem}
.bcard p:last-child{margin-bottom:0}
.bcard .inforow{display:flex;justify-content:space-between;padding:.5rem 0;border-bottom:1px solid var(--border);font-size:.82rem}
.bcard .inforow:last-child{border-bottom:none}
.bcard .inforow .il{color:var(--text3)}.bcard .inforow .iv{color:var(--text2);font-weight:600}

.btn-f{
  width:100%;padding:.75rem;border-radius:11px;border:none;
  font-family:'Nunito',sans-serif;font-size:.88rem;font-weight:700;
  cursor:pointer;-webkit-tap-highlight-color:transparent;transition:all .15s;margin-bottom:.5rem;
}
.btn-f:last-child{margin-bottom:0}
.btn-f:active{transform:scale(.98)}
.btn-prim{background:var(--gold);color:#0d1b2a}
.btn-prim:active{background:var(--gold2)}
.btn-sec{background:var(--card2);color:var(--text);border:1px solid var(--border2)}
.btn-gdrive{background:linear-gradient(135deg,#1a73e8,#0d5bbb);color:#fff}
.btn-danger{background:var(--rose-d);color:var(--rose);border:1px solid rgba(224,82,82,.2)}

/* â”€â”€ SETUP GUIDE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.setup-step{
  background:var(--card);border:1px solid var(--border);
  border-radius:12px;padding:1rem;margin-bottom:.65rem;
  display:flex;gap:.9rem;align-items:flex-start;
}
.step-num{
  width:28px;height:28px;border-radius:50%;
  background:var(--gold-d);border:1px solid rgba(200,151,63,.3);
  color:var(--gold2);font-size:.78rem;font-weight:700;
  display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:.1rem;
}
.step-body h4{font-size:.88rem;font-weight:700;margin-bottom:.3rem;color:var(--text)}
.step-body p{font-size:.78rem;color:var(--text2);line-height:1.5}
.step-body a{color:var(--sky);text-decoration:none}
.step-body code{background:var(--bg);padding:.1rem .4rem;border-radius:4px;font-size:.78rem;color:var(--gold2)}
.client-id-input{
  width:100%;background:var(--bg);border:1px solid var(--border2);
  border-radius:9px;padding:.65rem .9rem;
  color:var(--text);font-family:'Nunito',sans-serif;font-size:.82rem;
  outline:none;margin-top:.5rem;
}
.client-id-input:focus{border-color:rgba(200,151,63,.45)}

/* â”€â”€ FAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.fab{
  position:fixed;bottom:calc(var(--nav-h) + var(--safe-b) + .9rem);right:1.1rem;
  width:54px;height:54px;border-radius:50%;
  background:var(--gold);border:none;color:#0d1b2a;
  font-size:1.5rem;font-weight:300;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  box-shadow:0 4px 20px rgba(200,151,63,.35);
  -webkit-tap-highlight-color:transparent;transition:all .15s;z-index:100;
}
.fab:active{transform:scale(.91);background:var(--gold2)}
.fab.hide{display:none}

/* â”€â”€ SHEETS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.overlay{
  position:fixed;inset:0;z-index:200;
  background:rgba(0,0,0,.65);backdrop-filter:blur(5px);
  opacity:0;pointer-events:none;transition:opacity .25s;
}
.overlay.on{opacity:1;pointer-events:all}
.sheet{
  position:absolute;bottom:0;left:0;right:0;
  background:var(--bg2);border-radius:20px 20px 0 0;
  border-top:1px solid var(--border2);
  max-height:93dvh;display:flex;flex-direction:column;
  transform:translateY(100%);transition:transform .3s cubic-bezier(.34,1.06,.64,1);
  padding-bottom:var(--safe-b);
}
.overlay.on .sheet{transform:translateY(0)}
.s-handle{width:34px;height:4px;border-radius:2px;background:var(--border2);margin:.75rem auto 0;flex-shrink:0}
.s-head{padding:.85rem 1.1rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.s-head h3{font-family:'Libre Baskerville',serif;font-size:1.1rem;color:var(--gold2)}
.s-close{background:var(--card);border:1px solid var(--border);border-radius:7px;padding:.27rem .65rem;color:var(--text2);font-size:.78rem;cursor:pointer;font-family:'Nunito',sans-serif}
.s-body{flex:1;overflow-y:auto;padding:1.1rem;-webkit-overflow-scrolling:touch}
.s-foot{padding:.85rem 1.1rem;border-top:1px solid var(--border);display:flex;gap:.65rem;flex-shrink:0}

/* â”€â”€ FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.field{margin-bottom:.9rem}
.field label{display:block;font-size:.68rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.07em;margin-bottom:.35rem}
.field input,.field select,.field textarea{
  width:100%;background:var(--card);border:1px solid var(--border2);
  border-radius:9px;padding:.65rem .85rem;
  color:var(--text);font-family:'Nunito',sans-serif;font-size:.88rem;outline:none;transition:border-color .2s;
}
.field input:focus,.field select:focus,.field textarea:focus{border-color:rgba(200,151,63,.5)}
.field input::placeholder,.field textarea::placeholder{color:var(--text3)}
.field select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%234d6a85' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right .85rem center}
.field select option{background:#1a344f}
.field textarea{resize:vertical;min-height:75px}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:.7rem}

/* â”€â”€ FILE UPLOAD ZONE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.upload-zone{
  border:2px dashed var(--border2);border-radius:11px;
  padding:1.2rem;text-align:center;cursor:pointer;
  transition:all .2s;background:var(--card);
  position:relative;overflow:hidden;
}
.upload-zone:hover,.upload-zone.drag{border-color:rgba(200,151,63,.5);background:var(--gold-d)}
.upload-zone input{position:absolute;inset:0;opacity:0;cursor:pointer}
.upload-zone .uz-ico{font-size:2rem;margin-bottom:.4rem}
.upload-zone p{font-size:.8rem;color:var(--text2)}
.upload-zone p strong{color:var(--gold2)}
.upload-zone .uz-sub{font-size:.7rem;color:var(--text3);margin-top:.2rem}

.file-preview{
  background:var(--card);border:1px solid var(--border2);
  border-radius:9px;padding:.7rem .9rem;
  display:flex;align-items:center;gap:.75rem;margin-top:.6rem;
}
.fp-ico{font-size:1.4rem;flex-shrink:0}
.fp-info{flex:1;min-width:0}
.fp-name{font-size:.82rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.fp-size{font-size:.7rem;color:var(--text3)}
.fp-del{background:none;border:none;color:var(--text3);cursor:pointer;font-size:.9rem;padding:.2rem}
.fp-del:hover{color:var(--rose)}

/* â”€â”€ VIEW DOC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.vdoc-header{display:flex;align-items:center;gap:.8rem;margin-bottom:1.1rem}
.vdoc-icon{font-size:2.5rem}
.vdoc-title{font-size:1rem;font-weight:700;color:var(--text)}
.vdoc-sub{font-size:.75rem;color:var(--text3)}
.dr{display:flex;justify-content:space-between;align-items:flex-start;padding:.5rem 0;border-bottom:1px solid var(--border);gap:.75rem}
.dr:last-child{border-bottom:none}
.dl2{font-size:.75rem;color:var(--text3);flex-shrink:0}
.dv2{font-size:.85rem;color:var(--text2);text-align:right;word-break:break-word}
.dv2.mono{font-family:monospace;background:var(--card);padding:.15rem .45rem;border-radius:5px;font-size:.8rem;color:var(--gold2)}

.sync-row{
  display:flex;align-items:center;gap:.6rem;
  background:var(--card);border:1px solid var(--border);
  border-radius:10px;padding:.7rem .9rem;margin-bottom:.9rem;
}
.sync-row .sr-ico{font-size:1.2rem}
.sync-row .sr-text{flex:1;font-size:.78rem;color:var(--text2)}
.sync-row .sr-badge{font-size:.65rem;font-weight:700;padding:.18rem .5rem;border-radius:20px}

.file-view-btn{
  width:100%;padding:.7rem;border-radius:10px;
  background:var(--sky-d);color:var(--sky);
  border:1px solid rgba(74,159,212,.25);
  font-family:'Nunito',sans-serif;font-size:.85rem;font-weight:700;
  cursor:pointer;display:flex;align-items:center;justify-content:center;gap:.5rem;
  -webkit-tap-highlight-color:transparent;
  margin-bottom:.65rem;
}
.detail-acts{display:flex;gap:.6rem;margin-top:.9rem}
.da-btn{
  flex:1;padding:.65rem;border-radius:9px;
  font-family:'Nunito',sans-serif;font-size:.82rem;font-weight:700;
  cursor:pointer;text-align:center;border:1px solid var(--border2);
  background:var(--card2);color:var(--text2);
  -webkit-tap-highlight-color:transparent;
}
.da-del{background:var(--rose-d);color:var(--rose);border-color:rgba(224,82,82,.2)}

/* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast{
  position:fixed;bottom:calc(var(--nav-h) + var(--safe-b) + 5rem);
  left:50%;transform:translateX(-50%) translateY(20px);
  background:var(--card2);border:1px solid var(--border2);
  border-radius:10px;padding:.6rem 1.1rem;
  font-size:.82rem;font-weight:600;color:var(--text);
  opacity:0;transition:all .3s;z-index:9000;white-space:nowrap;
  box-shadow:0 8px 24px rgba(0,0,0,.4);
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* â”€â”€ SCROLLBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar{width:3px}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}

@media(min-width:480px){
  .frow{grid-template-columns:1fr 1fr}
  .sheet{max-width:480px;left:50%;right:auto;transform:translateX(-50%) translateY(100%);border-radius:20px 20px 0 0}
  .overlay.on .sheet{transform:translateX(-50%) translateY(0)}
}
</style>
</head>
<body>

<!-- LOCK SCREEN -->
<div id="lock">
  <div class="lock-emblem">ğŸ—„ï¸</div>
  <div class="lock-title" id="lockTitle">Family Vault</div>
  <div class="lock-sub" id="lockSub">Private Â· Offline Â· Google Drive Sync</div>
  <div class="lock-err" id="lerr"></div>
  <div class="pin-row" id="pdots">
    <div class="pin-dot" id="pd0"></div><div class="pin-dot" id="pd1"></div>
    <div class="pin-dot" id="pd2"></div><div class="pin-dot" id="pd3"></div>
  </div>
  <div class="numpad">
    <button class="nk" onclick="pk('1')">1</button>
    <button class="nk" onclick="pk('2')">2</button>
    <button class="nk" onclick="pk('3')">3</button>
    <button class="nk" onclick="pk('4')">4</button>
    <button class="nk" onclick="pk('5')">5</button>
    <button class="nk" onclick="pk('6')">6</button>
    <button class="nk" onclick="pk('7')">7</button>
    <button class="nk" onclick="pk('8')">8</button>
    <button class="nk" onclick="pk('9')">9</button>
    <button class="nk act" onclick="pb()">âŒ«</button>
    <button class="nk" onclick="pk('0')">0</button>
    <button class="nk ok" id="pok" onclick="pc()" disabled>â†’</button>
  </div>
  <p class="lock-hint" id="lhint">Create a 4-digit PIN to secure your vault</p>
  <button id="forgotBtn" onclick="showForgotPIN()"
    style="display:none;margin-top:1rem;background:none;border:none;color:var(--text3);font-family:'Nunito',sans-serif;font-size:.8rem;cursor:pointer;text-decoration:underline">
    Forgot PIN?
  </button>
  <button id="cancelPinBtn" onclick="cancelPinChange()"
    style="display:none;margin-top:.5rem;background:none;border:none;color:var(--text3);font-family:'Nunito',sans-serif;font-size:.8rem;cursor:pointer;text-decoration:underline">
    Cancel
  </button>
</div>

<!-- APP -->
<div id="app">
  <div class="topbar">
    <div class="topbar-brand">Family Vault</div>
    <button class="topbar-sync sync-noauth" id="syncBtn" onclick="handleSyncClick()">
      <span id="syncIco">â˜</span> <span id="syncTxt">Connect Drive</span>
    </button>
    <button class="ib" onclick="lockApp()" title="Lock">ğŸ”’</button>
  </div>

  <div class="content">
    <div class="view on" id="v-home"></div>
    <div class="view" id="v-docs"></div>
    <div class="view" id="v-members"></div>
    <div class="view" id="v-settings"></div>
  </div>

  <div class="bottomnav">
    <button class="ni on" id="n-home" onclick="sv('home')"><span class="ico">ğŸ </span><span>Home</span></button>
    <button class="ni" id="n-docs" onclick="sv('docs')"><span class="ico">ğŸ“„</span><span>Docs</span></button>
    <button class="ni" id="n-members" onclick="sv('members')"><span class="ico">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</span><span>Family</span></button>
    <button class="ni" id="n-settings" onclick="sv('settings')"><span class="ico">âš™ï¸</span><span>Settings</span></button>
  </div>

  <button class="fab" id="fab" onclick="openAddDoc()">ï¼‹</button>
</div>

<!-- ADD/EDIT DOC SHEET -->
<div class="overlay" id="docSheet">
  <div class="sheet">
    <div class="s-handle"></div>
    <div class="s-head">
      <h3 id="dsTitle">Add Document</h3>
      <button class="s-close" onclick="cs('docSheet')">Close</button>
    </div>
    <div class="s-body" style="padding:1rem">

      <!-- Row 1: Member + Type -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:.6rem;margin-bottom:.7rem">
        <div class="field" style="margin:0">
          <label>Member</label>
          <select id="fMember"></select>
        </div>
        <div class="field" style="margin:0">
          <label>Type</label>
          <select id="fType">
            <option value="id">ğŸªª Passport/ID</option>
            <option value="med">ğŸ¥ Medical</option>
            <option value="fin">ğŸ’° Financial</option>
            <option value="legal">âš–ï¸ Legal</option>
            <option value="birth">ğŸ“œ Birth/Marriage</option>
            <option value="other">ğŸ“„ Other</option>
          </select>
        </div>
      </div>

      <!-- Row 2: Document Name -->
      <div class="field">
        <label>Document Name *</label>
        <input type="text" id="fName" placeholder="e.g. Aadhaar, PAN, Passportâ€¦">
      </div>

      <!-- Row 3: Number + Expiry -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:.6rem;margin-bottom:.7rem">
        <div class="field" style="margin:0">
          <label>Document Number</label>
          <input type="text" id="fNumber" placeholder="Number / ID">
        </div>
        <div class="field" style="margin:0">
          <label>Expiry Date</label>
          <input type="date" id="fExpiry">
        </div>
      </div>

      <!-- Row 4: Issue Date + Issued By -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:.6rem;margin-bottom:.7rem">
        <div class="field" style="margin:0">
          <label>Issue Date</label>
          <input type="date" id="fIssue">
        </div>
        <div class="field" style="margin:0">
          <label>Issued By</label>
          <input type="text" id="fIssuer" placeholder="Authorityâ€¦">
        </div>
      </div>

      <!-- Row 5: Physical Location â€” FULL WIDTH -->
      <div class="field" style="background:var(--card2);border:1px solid rgba(200,151,63,.25);border-radius:10px;padding:.7rem;margin-bottom:.7rem">
        <label style="color:var(--gold2)">ğŸ“ Physical Location</label>
        <input type="text" id="fLocation" placeholder="e.g. Blue folder in wardrobe, Safe, Drawer, Cupboardâ€¦" style="background:var(--card);margin-top:.1rem">
      </div>

      <!-- Row 6: File Upload â€” PROMINENT -->
      <div class="field" style="margin-bottom:.7rem">
        <label style="color:var(--gold2)">ğŸ“ Attach File (PDF / Image)</label>
        <input type="file" id="fileInput" accept=".pdf,image/*" style="display:none" onchange="handleFile(this.files[0])">
        <div id="filePreview" style="display:none;background:var(--card);border:1px solid var(--border2);border-radius:9px;padding:.7rem .9rem;align-items:center;gap:.75rem;">
          <div id="fpIco" style="font-size:1.4rem;flex-shrink:0">ğŸ“„</div>
          <div style="flex:1;min-width:0">
            <div id="fpName" style="font-size:.82rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis"></div>
            <div id="fpSize" style="font-size:.7rem;color:var(--text3)"></div>
          </div>
          <button onclick="clearFile()" style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:.9rem;padding:.2rem">âœ•</button>
        </div>
        <div id="uploadZone" style="border:2px dashed rgba(200,151,63,.4);border-radius:11px;padding:1rem;text-align:center;background:var(--card);"
          ondragover="event.preventDefault();this.style.borderColor='var(--gold)'"
          ondragleave="this.style.borderColor='rgba(200,151,63,.4)'"
          ondrop="handleDrop(event)">
          <div style="font-size:1.8rem;margin-bottom:.3rem">ğŸ“</div>
          <p style="font-size:.78rem;color:var(--text2);margin-bottom:.5rem">Attach a scan, photo or PDF of this document</p>
          <button type="button"
            onclick="document.getElementById('fileInput').click()"
            style="background:var(--gold);color:#0d1b2a;border:none;border-radius:8px;padding:.55rem 1.5rem;font-family:'Nunito',sans-serif;font-size:.88rem;font-weight:700;cursor:pointer;width:100%">
            ğŸ“ Browse & Attach File
          </button>
          <p style="font-size:.68rem;color:var(--text3);margin-top:.4rem">PDF, JPG, PNG â€” max 10 MB</p>
        </div>
      </div>

      <!-- Row 7: Notes -->
      <div class="field">
        <label>Notes / Reminders</label>
        <textarea id="fNotes" placeholder="Renewal info, linked docs, remarksâ€¦" style="min-height:60px"></textarea>
      </div>

      <!-- Row 8: Tags -->
      <div class="field">
        <label>Tags (comma separated)</label>
        <input type="text" id="fTags" placeholder="original, urgent, renewal-due">
      </div>

    </div>
    <div class="s-foot">
      <button class="da-btn" onclick="cs('docSheet')">Cancel</button>
      <button class="btn-f btn-prim" style="flex:1;margin:0" onclick="saveDoc()">Save Document</button>
    </div>
  </div>
</div>

<!-- VIEW DOC SHEET -->
<div class="overlay" id="viewSheet">
  <div class="sheet">
    <div class="s-handle"></div>
    <div class="s-head">
      <h3 id="vsTitle">Document</h3>
      <button class="s-close" onclick="cs('viewSheet')">Close</button>
    </div>
    <div class="s-body" id="vsBody"></div>
  </div>
</div>

<!-- ADD MEMBER SHEET -->
<div class="overlay" id="memberSheet">
  <div class="sheet">
    <div class="s-handle"></div>
    <div class="s-head"><h3>Add Family Member</h3><button class="s-close" onclick="cs('memberSheet')">Close</button></div>
    <div class="s-body">
      <div class="field"><label>Full Name *</label><input type="text" id="mName" placeholder="Name"></div>
      <div class="frow">
        <div class="field"><label>Relation</label>
          <select id="mRel">
            <option>Self</option><option>Spouse</option><option>Father</option><option>Mother</option>
            <option>Son</option><option>Daughter</option><option>Brother</option><option>Sister</option>
            <option>Father-in-law</option><option>Mother-in-law</option>
            <option>Grandfather</option><option>Grandmother</option><option>Other</option>
          </select>
        </div>
        <div class="field"><label>Date of Birth</label><input type="date" id="mDob"></div>
      </div>
    </div>
    <div class="s-foot">
      <button class="da-btn" onclick="cs('memberSheet')">Cancel</button>
      <button class="btn-f btn-prim" style="flex:1;margin:0" onclick="saveMember()">Add Member</button>
    </div>
  </div>
</div>

<input type="file" id="importInput" accept=".json" style="display:none" onchange="importVault(event)">
<div class="toast" id="toast"></div>

<!-- ADD CATEGORY SHEET -->
<div class="overlay" id="catSheet">
  <div class="sheet">
    <div class="s-handle"></div>
    <div class="s-head"><h3>Add Custom Category</h3><button class="s-close" onclick="cs('catSheet')">Close</button></div>
    <div class="s-body">
      <div class="field">
        <label>Category Name *</label>
        <input type="text" id="catName" placeholder="e.g. Vehicle, Insurance, Educationâ€¦" oninput="updateCatPreview()">
      </div>
      <div class="field">
        <label>Icon (Tap an emoji below)</label>
        <input type="text" id="catIcon" placeholder="ğŸ“„" maxlength="4" oninput="updateCatPreview()"
          style="font-size:1.5rem;text-align:center;letter-spacing:.3em;margin-bottom:.5rem">
        <div id="emojiPicker" style="display:flex;flex-wrap:wrap;gap:.4rem"></div>
      </div>
      <div class="field">
        <label>Folder Color</label>
        <div id="colorPicker" style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.2rem"></div>
      </div>
      <div style="background:var(--card);border-radius:10px;padding:.8rem;margin-top:.5rem">
        <div style="font-size:.72rem;color:var(--text3);margin-bottom:.4rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em">Preview</div>
        <div style="display:flex;align-items:center;gap:.75rem">
          <div id="catPreviewIcon" style="width:42px;height:42px;border-radius:10px;background:rgba(74,159,212,.15);display:flex;align-items:center;justify-content:center;font-size:1.2rem">ğŸ“„</div>
          <div>
            <div id="catPreviewName" style="font-size:.9rem;font-weight:700">New Category</div>
            <div style="font-size:.72rem;color:var(--text3)">Custom category</div>
          </div>
        </div>
      </div>
    </div>
    <div class="s-foot">
      <button class="da-btn" onclick="cs('catSheet')">Cancel</button>
      <button class="btn-f btn-prim" style="flex:1;margin:0" onclick="saveCategory()">Add Category</button>
    </div>
  </div>
</div>

<!-- CHANGE PIN SHEET -->
<div class="overlay" id="changePinSheet">
  <div class="sheet" style="max-height:75dvh">
    <div class="s-handle"></div>
    <div class="s-head"><h3>Change PIN</h3><button class="s-close" onclick="cs('changePinSheet')">Close</button></div>
    <div class="s-body" style="text-align:center">
      <p style="font-size:.82rem;color:var(--text2);margin-bottom:1rem" id="changePinMsg">Enter your current PIN to continue</p>
      <div style="display:flex;gap:.75rem;justify-content:center;margin-bottom:1.2rem">
        <div class="pin-dot" id="cpd0"></div>
        <div class="pin-dot" id="cpd1"></div>
        <div class="pin-dot" id="cpd2"></div>
        <div class="pin-dot" id="cpd3"></div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,64px);gap:.55rem;justify-content:center">
        <button class="nk" style="width:64px;height:64px" onclick="cpk('1')">1</button>
        <button class="nk" style="width:64px;height:64px" onclick="cpk('2')">2</button>
        <button class="nk" style="width:64px;height:64px" onclick="cpk('3')">3</button>
        <button class="nk" style="width:64px;height:64px" onclick="cpk('4')">4</button>
        <button class="nk" style="width:64px;height:64px" onclick="cpk('5')">5</button>
        <button class="nk" style="width:64px;height:64px" onclick="cpk('6')">6</button>
        <button class="nk" style="width:64px;height:64px" onclick="cpk('7')">7</button>
        <button class="nk" style="width:64px;height:64px" onclick="cpk('8')">8</button>
        <button class="nk" style="width:64px;height:64px" onclick="cpk('9')">9</button>
        <button class="nk act" style="width:64px;height:64px;font-size:.9rem" onclick="cpb()">âŒ«</button>
        <button class="nk" style="width:64px;height:64px" onclick="cpk('0')">0</button>
        <button class="nk ok" style="width:64px;height:64px;font-size:1.1rem" id="cpok" onclick="cpc()" disabled>â†’</button>
      </div>
      <div style="height:1.2rem;font-size:.78rem;color:var(--rose);margin-top:.75rem" id="changePinErr"></div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG & STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SK = 'fvault3';
const PK = 'fvault3_pin';
const CID_KEY = 'fvault3_cid';
// â”€â”€â”€ PASTE YOUR GOOGLE CLIENT ID HERE ONCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const HARDCODED_CLIENT_ID = '639675930352-kbjneusm429kp075dapmlfa8lvo8cs4s.apps.googleusercontent.com';
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

let V = { members: [], docs: [] };           // vault metadata
let DB = null;                                 // IndexedDB
let gToken = null;                             // Google access token
let gDriveFolderId = null;                     // "Family Vault" folder on Drive
let currentView = 'home';
let editId = null;
let fMem = 'all', fType = '';
let pendingFile = null;                        // { name, size, type, data (base64) }
let deferInstall = null;
let syncing = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INDEXEDDB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDB() {
  return new Promise((res, rej) => {
    const req = indexedDB.open('FamilyVaultFiles', 1);
    req.onupgradeneeded = e => e.target.result.createObjectStore('files', { keyPath: 'docId' });
    req.onsuccess = e => res(e.target.result);
    req.onerror = () => rej(req.error);
  });
}
async function saveFile(docId, fileObj) {
  if (!DB) return;
  return new Promise((res, rej) => {
    const tx = DB.transaction('files', 'readwrite');
    tx.objectStore('files').put({ docId, ...fileObj });
    tx.oncomplete = res; tx.onerror = () => rej(tx.error);
  });
}
async function getFile(docId) {
  if (!DB) return null;
  return new Promise((res) => {
    const tx = DB.transaction('files', 'readonly');
    const req = tx.objectStore('files').get(docId);
    req.onsuccess = () => res(req.result || null);
    req.onerror = () => res(null);
  });
}
async function deleteFile(docId) {
  if (!DB) return;
  return new Promise(res => {
    const tx = DB.transaction('files', 'readwrite');
    tx.objectStore('files').delete(docId);
    tx.oncomplete = res;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2,5); }
function saveData() { try { localStorage.setItem(SK, JSON.stringify(V)); } catch(e){} }
function loadData() {
  try {
    const r = localStorage.getItem(SK);
    if (r) V = JSON.parse(r);
    if (!Array.isArray(V.members)) V.members = [];
    if (!Array.isArray(V.docs)) V.docs = [];
    if (!Array.isArray(V.categories)) V.categories = [];
    // Restore custom categories into CAT_FOLDERS
    V.categories.forEach(c=>{ CAT_FOLDERS[c.id]=c.label; });
    if (!V.members.length) { V.members.push({ id: uid(), name: 'Self', relation: 'Self', dob: '' }); saveData(); }
  } catch(e) { V = { members: [], docs: [] }; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PIN â€” LOCK SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let pin = '';
let pinMode = 'unlock'; // unlock | newpin | confirm
let pinTemp = '';       // stores first entry during newpin flow

function pk(d) { if(pin.length>=4)return; pin+=d; upd(); if(pin.length===4) document.getElementById('pok').disabled=false; }
function pb() { pin=pin.slice(0,-1); document.getElementById('pok').disabled=true; upd(); }
function upd() { for(let i=0;i<4;i++) document.getElementById('pd'+i).classList.toggle('on',i<pin.length); }

function pc() {
  if(pin.length!==4)return;
  const saved=localStorage.getItem(PK);

  if(pinMode==='unlock'){
    if(!saved){ pinMode='newpin'; pinTemp=pin; pin=''; upd(); document.getElementById('pok').disabled=true;
      document.getElementById('lhint').textContent='Enter PIN again to confirm';
      document.getElementById('lerr').textContent=''; return; }
    if(btoa(pin)===saved){ boot(); return; }
    document.getElementById('lerr').textContent='Incorrect PIN. Try again.';
    setTimeout(()=>document.getElementById('lerr').textContent='',2000);
    pin=''; upd(); document.getElementById('pok').disabled=true;

  } else if(pinMode==='newpin'){
    pinTemp=pin; pin=''; upd(); document.getElementById('pok').disabled=true;
    pinMode='confirm';
    document.getElementById('lhint').textContent='Confirm your new PIN';

  } else if(pinMode==='confirm'){
    if(pin===pinTemp){
      localStorage.setItem(PK,btoa(pin));
      document.getElementById('lerr').textContent='';
      document.getElementById('lhint').textContent='PIN set! Opening vaultâ€¦';
      pinMode='unlock';
      setTimeout(()=>boot(),500);
    } else {
      document.getElementById('lerr').textContent='PINs do not match. Start again.';
      pinTemp=''; pin=''; upd(); document.getElementById('pok').disabled=true;
      pinMode='newpin';
      setTimeout(()=>{ document.getElementById('lerr').textContent='';
        document.getElementById('lhint').textContent='Enter your new PIN'; },2000);
    }
  }
}

function showForgotPIN(){
  if(!confirm('Reset PIN using Google Drive sign-in?\n\nThis will sign you in with Google to verify your identity, then let you set a new PIN. Your vault data will be preserved.'))return;
  sessionStorage.setItem('pinreset','1');
  gdriveAuth();
}
function cancelPinChange(){
  pinMode='unlock'; pinTemp=''; pin=''; upd();
  document.getElementById('pok').disabled=true;
  document.getElementById('lhint').textContent='Enter your PIN to unlock';
  document.getElementById('lerr').textContent='';
  document.getElementById('lockTitle').textContent='Family Vault';
  document.getElementById('cancelPinBtn').style.display='none';
  document.getElementById('forgotBtn').style.display=localStorage.getItem(PK)?'block':'none';
}

async function boot() {
  loadData();
  DB = await openDB();
  document.getElementById('lock').style.display='none';
  document.getElementById('app').classList.add('on');
  document.getElementById('lhint').textContent='Enter your PIN to unlock';
  document.getElementById('forgotBtn').style.display='block';
  document.getElementById('cancelPinBtn').style.display='none';
  pinMode='unlock'; pin=''; upd(); document.getElementById('pok').disabled=true;
  restoreGDriveState();
  renderAll();
}
function lockApp() {
  document.getElementById('app').classList.remove('on');
  document.getElementById('lock').style.display='flex';
  pin=''; pinMode='unlock'; upd(); document.getElementById('pok').disabled=true;
  document.getElementById('lerr').textContent='';
  document.getElementById('lhint').textContent='Enter your PIN to unlock';
  document.getElementById('lockTitle').textContent='Family Vault';
}
if(localStorage.getItem(PK)){
  document.getElementById('lhint').textContent='Enter your 4-digit PIN to unlock';
  document.getElementById('forgotBtn').style.display='block';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHANGE PIN â€” IN-APP SHEET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let cpPin='', cpStep='current', cpNewPin='';

function openChangePIN(){
  cpPin=''; cpStep='current'; cpNewPin='';
  document.getElementById('changePinMsg').textContent='Enter your current PIN to continue';
  document.getElementById('changePinErr').textContent='';
  updCp(); document.getElementById('cpok').disabled=true;
  os('changePinSheet');
}
function cpk(d){ if(cpPin.length>=4)return; cpPin+=d; updCp(); if(cpPin.length===4) document.getElementById('cpok').disabled=false; }
function cpb(){ cpPin=cpPin.slice(0,-1); document.getElementById('cpok').disabled=true; updCp(); }
function updCp(){ for(let i=0;i<4;i++) document.getElementById('cpd'+i).classList.toggle('on',i<cpPin.length); }
function cpc(){
  if(cpPin.length!==4)return;
  if(cpStep==='current'){
    if(btoa(cpPin)!==localStorage.getItem(PK)){
      document.getElementById('changePinErr').textContent='Incorrect PIN.';
      setTimeout(()=>document.getElementById('changePinErr').textContent='',2000);
      cpPin=''; updCp(); document.getElementById('cpok').disabled=true; return;
    }
    cpStep='new'; cpPin=''; updCp(); document.getElementById('cpok').disabled=true;
    document.getElementById('changePinMsg').textContent='Enter your new PIN';
  } else if(cpStep==='new'){
    cpNewPin=cpPin; cpPin=''; updCp(); document.getElementById('cpok').disabled=true;
    cpStep='confirm';
    document.getElementById('changePinMsg').textContent='Confirm your new PIN';
  } else if(cpStep==='confirm'){
    if(cpPin===cpNewPin){
      localStorage.setItem(PK,btoa(cpPin));
      cs('changePinSheet'); toast('âœ… PIN changed successfully!');
      cpPin=''; cpStep='current'; cpNewPin='';
    } else {
      document.getElementById('changePinErr').textContent='PINs do not match. Try again.';
      cpPin=''; cpNewPin=''; cpStep='new'; updCp(); document.getElementById('cpok').disabled=true;
      setTimeout(()=>{ document.getElementById('changePinErr').textContent='';
        document.getElementById('changePinMsg').textContent='Enter your new PIN'; },2000);
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GOOGLE DRIVE AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getClientId() { return HARDCODED_CLIENT_ID || localStorage.getItem(CID_KEY) || ''; }

function restoreGDriveState() {
  gToken = sessionStorage.getItem('gtoken') || null;
  gDriveFolderId = sessionStorage.getItem('gfolderid') || null;
  updateSyncUI();
}

function handleSyncClick() {
  if (!gToken) { gdriveAuth(); }
  else { manualSync(); }
}

function gdriveAuth() {
  const cid = getClientId();
  if (!cid || cid.includes('PASTE_YOUR')) { toast('âš ï¸ Client ID not configured. Contact app owner.'); return; }
  const params = new URLSearchParams({
    client_id: cid,
    redirect_uri: location.origin + location.pathname,
    response_type: 'token',
    scope: SCOPES,
    include_granted_scopes: 'true',
  });
  sessionStorage.setItem('auth_return_view', currentView);
  location.href = 'https://accounts.google.com/o/oauth2/v2/auth?' + params.toString();
}

function handleOAuthCallback() {
  const hash = location.hash.substring(1);
  if (!hash.includes('access_token')) return;
  const params = new URLSearchParams(hash);
  const token = params.get('access_token');
  if (token) {
    gToken = token;
    sessionStorage.setItem('gtoken', token);
    history.replaceState(null,'',location.pathname);
    // Check if this was a PIN reset flow
    if(sessionStorage.getItem('pinreset')==='1'){
      sessionStorage.removeItem('pinreset');
      localStorage.removeItem(PK);
      // Show new PIN creation on lock screen
      pinMode='newpin';
      document.getElementById('lockTitle').textContent='Set New PIN';
      document.getElementById('lhint').textContent='Enter a new 4-digit PIN';
      document.getElementById('lerr').textContent='';
      document.getElementById('cancelPinBtn').style.display='block';
      document.getElementById('forgotBtn').style.display='none';
      pin=''; upd(); document.getElementById('pok').disabled=true;
      return;
    }
    updateSyncUI();
    toast('âœ… Google Drive connected!');
    autoSync();
  }
}

function updateSyncUI() {
  const btn = document.getElementById('syncBtn');
  const ico = document.getElementById('syncIco');
  const txt = document.getElementById('syncTxt');
  if (!gToken) {
    btn.className = 'topbar-sync sync-noauth';
    ico.textContent = 'â˜'; txt.textContent = 'Connect Drive';
  } else if (syncing) {
    btn.className = 'topbar-sync sync-ing';
    ico.textContent = 'ğŸ”„'; txt.textContent = 'Syncingâ€¦';
  } else {
    btn.className = 'topbar-sync sync-idle';
    ico.textContent = 'âœ“'; txt.textContent = 'Drive Synced';
  }
  if (currentView==='home') renderHome();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GOOGLE DRIVE API CALLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function driveReq(method, url, body, headers={}) {
  if (!gToken) return null;
  try {
    const r = await fetch(url, {
      method,
      headers: { 'Authorization': 'Bearer '+gToken, ...headers },
      body
    });
    if (r.status===401) { gToken=null; sessionStorage.removeItem('gtoken'); updateSyncUI(); return null; }
    if (!r.ok) return null;
    return r.headers.get('content-type')?.includes('json') ? r.json() : r;
  } catch(e) { return null; }
}

// Category folder names mapping
const CAT_FOLDERS = {
  id:    'Passport-ID',
  med:   'Medical',
  fin:   'Financial',
  legal: 'Legal',
  birth: 'Birth-Marriage',
  other: 'Other'
};

// Cache for category folder IDs: { 'Passport-ID': 'folderId', ... }
let catFolderCache = {};

async function getOrCreateFolder() {
  if (gDriveFolderId) return gDriveFolderId;
  // Search for existing root Family Vault folder
  const q = encodeURIComponent("name='Family Vault' and mimeType='application/vnd.google-apps.folder' and trashed=false");
  const res = await driveReq('GET', `https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id,name)`);
  if (res?.files?.length) {
    gDriveFolderId = res.files[0].id;
    sessionStorage.setItem('gfolderid', gDriveFolderId);
    return gDriveFolderId;
  }
  // Create root folder
  const meta = JSON.stringify({ name:'Family Vault', mimeType:'application/vnd.google-apps.folder' });
  const cr = await driveReq('POST','https://www.googleapis.com/drive/v3/files',meta,{'Content-Type':'application/json'});
  if (cr?.id) {
    gDriveFolderId = cr.id;
    sessionStorage.setItem('gfolderid', gDriveFolderId);
    return gDriveFolderId;
  }
  return null;
}

async function getOrCreateCategoryFolder(docType) {
  const catName = CAT_FOLDERS[docType] || 'Other';
  // Return from cache if already fetched this session
  if (catFolderCache[catName]) return catFolderCache[catName];
  const rootId = await getOrCreateFolder();
  if (!rootId) return null;
  // Search for existing category subfolder
  const q = encodeURIComponent(`name='${catName}' and '${rootId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`);
  const res = await driveReq('GET', `https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id,name)`);
  if (res?.files?.length) {
    catFolderCache[catName] = res.files[0].id;
    return catFolderCache[catName];
  }
  // Create category subfolder inside Family Vault
  const meta = JSON.stringify({ name: catName, mimeType:'application/vnd.google-apps.folder', parents:[rootId] });
  const cr = await driveReq('POST','https://www.googleapis.com/drive/v3/files',meta,{'Content-Type':'application/json'});
  if (cr?.id) {
    catFolderCache[catName] = cr.id;
    return catFolderCache[catName];
  }
  return null;
}

async function uploadFileToDrive(docId, fileObj, docType) {
  // Get the category subfolder
  const folderId = await getOrCreateCategoryFolder(docType || 'other');
  if (!folderId) return null;
  // Convert base64 to blob
  const bytes = atob(fileObj.data);
  const arr = new Uint8Array(bytes.length);
  for (let i=0;i<bytes.length;i++) arr[i]=bytes.charCodeAt(i);
  const blob = new Blob([arr],{type:fileObj.type});
  const meta = JSON.stringify({ name: fileObj.name, parents: [folderId], description: `DocID:${docId}` });
  const form = new FormData();
  form.append('metadata', new Blob([meta],{type:'application/json'}));
  form.append('file', blob);
  const res = await driveReq('POST','https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink',form);
  return res?.id ? { driveFileId: res.id, driveLink: res.webViewLink } : null;
}

async function uploadMetaToDrive() {
  const folderId = await getOrCreateFolder();
  if (!folderId) return;
  const content = JSON.stringify(V, null, 2);
  const blob = new Blob([content],{type:'application/json'});

  // Check if backup file already exists
  const doc = V.docs; // keep reference
  const q = encodeURIComponent(`name='vault-metadata.json' and '${folderId}' in parents and trashed=false`);
  const existing = await driveReq('GET',`https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id)`);

  if (existing?.files?.length) {
    const fileId = existing.files[0].id;
    await driveReq('PATCH',`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`,blob,{'Content-Type':'application/json'});
  } else {
    const meta = JSON.stringify({ name:'vault-metadata.json', parents:[folderId] });
    const form = new FormData();
    form.append('metadata',new Blob([meta],{type:'application/json'}));
    form.append('file',blob);
    await driveReq('POST','https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',form);
  }
}

async function autoSync(docId, fileObj, docType) {
  if (!gToken || syncing) return;
  syncing = true; updateSyncUI();
  try {
    // upload specific file if provided
    if (docId && fileObj) {
      const result = await uploadFileToDrive(docId, fileObj, docType);
      if (result) {
        const doc = V.docs.find(d=>d.id===docId);
        if (doc) { doc.driveFileId=result.driveFileId; doc.driveLink=result.driveLink; doc.synced=true; saveData(); }
      }
    }
    // always update metadata
    await uploadMetaToDrive();
    V.lastSync = new Date().toISOString();
    saveData();
    toast('âœ… Synced to Google Drive');
  } catch(e) {
    toast('âš ï¸ Sync failed. Check connection.');
  }
  syncing = false; updateSyncUI();
}

async function manualSync() {
  if (!gToken) { gdriveAuth(); return; }
  toast('ğŸ”„ Syncing all documentsâ€¦');
  syncing = true; updateSyncUI();
  try {
    const folderId = await getOrCreateFolder();
    if (!folderId) throw new Error('No folder');
    // sync files for docs that have files but no driveFileId
    for (const doc of V.docs) {
      if (doc.hasFile && !doc.driveFileId) {
        const fileObj = await getFile(doc.id);
        if (fileObj) {
          const result = await uploadFileToDrive(doc.id, fileObj, doc.type);
          if (result) { doc.driveFileId=result.driveFileId; doc.driveLink=result.driveLink; doc.synced=true; }
        }
      }
    }
    await uploadMetaToDrive();
    V.lastSync = new Date().toISOString();
    saveData(); renderAll();
    toast('âœ… All documents synced to Drive!');
  } catch(e) { toast('âš ï¸ Sync failed. Try again.'); }
  syncing = false; updateSyncUI();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VIEWS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sv(v) {
  currentView=v;
  document.querySelectorAll('.view').forEach(e=>e.classList.remove('on'));
  document.querySelectorAll('.ni').forEach(e=>e.classList.remove('on'));
  document.getElementById('v-'+v).classList.add('on');
  document.getElementById('n-'+v).classList.add('on');
  document.getElementById('fab').classList.toggle('hide',v==='settings'||v==='members');
  // show add member fab for members view
  if (v==='members') document.getElementById('fab').classList.remove('hide'), document.getElementById('fab').onclick=openAddMember;
  else document.getElementById('fab').onclick=openAddDoc;
  renderView(v);
}
function renderAll() { renderView(currentView); }
function renderView(v) {
  if (v==='home') renderHome();
  else if (v==='docs') renderDocs();
  else if (v==='members') renderMembers();
  else if (v==='settings') renderSettings();
}

// â”€â”€â”€ HOME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderHome() {
  const today=new Date(); today.setHours(0,0,0,0);
  const soon=new Date(today); soon.setDate(soon.getDate()+90);
  const expired=V.docs.filter(d=>d.expiry&&new Date(d.expiry)<today);
  const expiring=V.docs.filter(d=>d.expiry&&new Date(d.expiry)>=today&&new Date(d.expiry)<=soon);
  const synced=V.docs.filter(d=>d.synced).length;

  const alerts=[
    ...expired.map(d=>{const m=V.members.find(x=>x.id===d.memberId);return`<div class="al exp" onclick="viewDoc('${d.id}')"><div class="al-dot exp"></div><div style="flex:1"><div class="al-name">${d.name}</div><div class="al-sub">${m?.name||''}</div></div><span class="badge exp">Expired</span></div>`;}),
    ...expiring.map(d=>{const m=V.members.find(x=>x.id===d.memberId);const dy=Math.ceil((new Date(d.expiry)-today)/86400000);return`<div class="al warn" onclick="viewDoc('${d.id}')"><div class="al-dot warn"></div><div style="flex:1"><div class="al-name">${d.name}</div><div class="al-sub">${m?.name||''}</div></div><span class="badge warn">${dy}d left</span></div>`;})
  ].join('');

  const gStatus = gToken
    ? `<div class="gdrive-status gds-conn">âœ… Google Drive connected Â· ${synced} file${synced!==1?'s':''} synced</div>`
    : `<div class="gdrive-status gds-disc" onclick="handleSyncClick()">âš ï¸ Google Drive not connected â€” tap to connect</div>`;

  TM = getTM();
  const typeData = Object.entries(TM).map(([t,{icon,label}])=>[t,icon,label]);

  document.getElementById('v-home').innerHTML=`
    <div class="hero">
      <h2>Welcome, ${V.members[0]?.name||'Family'}!</h2>
      <p>${V.docs.length} document${V.docs.length!==1?'s':''} Â· ${V.members.length} member${V.members.length!==1?'s':''}</p>
      ${gStatus}
    </div>
    <div class="s4">
      <div class="tile"><div class="ico2" style="background:var(--gold-d)">ğŸ“</div><div><div class="tl">Total Docs</div><div class="tv">${V.docs.length}</div></div></div>
      <div class="tile"><div class="ico2" style="background:var(--teal-d)">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</div><div><div class="tl">Members</div><div class="tv">${V.members.length}</div></div></div>
      <div class="tile"><div class="ico2" style="background:var(--rose-d)">âŒ</div><div><div class="tl">Expired</div><div class="tv">${expired.length}</div></div></div>
      <div class="tile"><div class="ico2" style="background:var(--green-d)">â˜ï¸</div><div><div class="tl">On Drive</div><div class="tv">${synced}</div></div></div>
    </div>
    ${alerts?`<div class="sec-title">âš ï¸ Alerts</div><div class="alert-list">${alerts}</div>`:''}
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.65rem">
      <div class="sec-title" style="margin:0">Browse by Category</div>
      <button onclick="openAddCategory()" style="background:var(--gold-d);border:1px solid rgba(200,151,63,.3);color:var(--gold2);border-radius:8px;padding:.3rem .75rem;font-size:.75rem;font-weight:700;cursor:pointer;font-family:'Nunito',sans-serif">ï¼‹ Add Category</button>
    </div>
    <div class="type-grid">
      ${typeData.map(([t,ic,lb])=>{
        const cnt=V.docs.filter(d=>d.type===t).length;
        const color=TM[t]?.color||'#4d6a85';
        const isCustom=!BASE_CATS[t];
        return`<div class="type-tile" onclick="quickFilter('${t}')" style="position:relative">
          ${isCustom?`<button onclick="event.stopPropagation();deleteCategory('${t}')" style="position:absolute;top:.35rem;right:.35rem;background:none;border:none;color:var(--text3);font-size:.65rem;cursor:pointer;padding:.1rem">âœ•</button>`:''}
          <div class="ti">${ic}</div>
          <div class="tn">${lb}</div>
          <div class="tc">${cnt}</div>
        </div>`;
      }).join('')}
      <div class="type-tile" onclick="openAddCategory()" style="border-style:dashed;color:var(--text3)">
        <div class="ti" style="font-size:1.8rem">ï¼‹</div>
        <div class="tn">New Category</div>
        <div class="tc" style="font-size:.7rem;color:var(--text3)">custom</div>
      </div>
    </div>`;
}

function quickFilter(t){fType=t;sv('docs');}

// â”€â”€â”€ DOCS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Base categories â€” always present
const BASE_CATS = {
  id:    {label:'Passport/ID',    icon:'ğŸªª', color:'#4a9fd4'},
  med:   {label:'Medical',        icon:'ğŸ¥', color:'#38b2ac'},
  fin:   {label:'Financial',      icon:'ğŸ’°', color:'#c8973f'},
  legal: {label:'Legal',          icon:'âš–ï¸', color:'#9f7aea'},
  birth: {label:'Birth/Marriage', icon:'ğŸ“œ', color:'#48bb78'},
  other: {label:'Other',          icon:'ğŸ“„', color:'#4d6a85'},
};
// Dynamic TM = base + custom from vault
function getTM(){
  const custom = {};
  (V.categories||[]).forEach(c=>{ custom[c.id]={label:c.label,icon:c.icon,color:c.color}; });
  return {...BASE_CATS,...custom};
}
// Get TM once per render
let TM = BASE_CATS;
function renderDocs(){
  TM = getTM();
  const q=(document.getElementById('docSearch')?.value||'').toLowerCase();
  const today=new Date();today.setHours(0,0,0,0);
  const soon=new Date(today);soon.setDate(soon.getDate()+90);
  let docs=V.docs.filter(d=>{
    if(fMem!=='all'&&d.memberId!==fMem)return false;
    if(fType&&d.type!==fType)return false;
    if(q){const h=[d.name,d.number,d.notes,d.issuer,d.location,...(d.tags||[])].join(' ').toLowerCase();if(!h.includes(q))return false;}
    return true;
  });
  const mchips=`<div class="chip ${fMem==='all'?'on':''}" onclick="setMF('all')">All</div>${V.members.map(m=>`<div class="chip ${fMem===m.id?'on':''}" onclick="setMF('${m.id}')">${m.name}</div>`).join('')}`;
  const tchips=`<div class="chip ${!fType?'on':''}" onclick="setTF('')">All Types</div>${Object.entries(TM).map(([t,{icon,label}])=>`<div class="chip ${fType===t?'on':''}" onclick="setTF('${t}')">${icon} ${label}</div>`).join('')}`;

  const list=docs.length?docs.map(d=>{
    const m=V.members.find(x=>x.id===d.memberId);
    const tm=TM[d.type]||TM.other;
    let pill='No expiry',pcls='ep-none';
    if(d.expiry){const e=new Date(d.expiry);e.setHours(0,0,0,0);
      if(e<today){pill='Expired';pcls='ep-exp';}
      else if(e<=soon){const dy=Math.ceil((e-today)/86400000);pill=`${dy}d`;pcls='ep-soon';}
      else{pill='Valid';pcls='ep-ok';}
    }
    const syncPill=gToken?(d.synced?'<span class="epill ep-sync" style="font-size:.58rem">â˜ Drive</span>':'<span class="epill ep-nosync" style="font-size:.58rem">â³ Pending</span>'):'';
    const barColor = tm.color||'#4d6a85';
    return`<div class="drow" onclick="viewDoc('${d.id}')">
      <div class="dbar" style="background:linear-gradient(180deg,${barColor},${barColor}99)"></div>
      <div class="dbody">
        <div class="dname">${d.name}${d.hasFile?'<span class="file-ico">ğŸ“ File</span>':''}</div>
        <div class="dmeta"><span>ğŸ‘¤ ${m?.name||'â€”'}</span><span>${tm.icon} ${tm.label}</span>${d.location?`<span>ğŸ“ ${d.location}</span>`:''}</div>
      </div>
      <div class="dright">
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:.25rem">
          <span class="epill ${pcls}">${pill}</span>${syncPill}
        </div>
        <div class="row-acts" onclick="event.stopPropagation()">
          <button class="mb" onclick="editDoc('${d.id}')">âœï¸</button>
          <button class="mb del" onclick="deleteDoc('${d.id}')">ğŸ—‘</button>
        </div>
      </div>
    </div>`;
  }).join(''):`<div class="empty"><div class="ei">ğŸ—„ï¸</div><h3>No Documents</h3><p>Tap ï¼‹ to add your first document.</p></div>`;

  document.getElementById('v-docs').innerHTML=`
    <div class="search-wrap"><span class="si">ğŸ”</span><input id="docSearch" type="search" placeholder="Searchâ€¦" oninput="renderDocs()" value="${q}"></div>
    <div class="chips">${mchips}</div>
    <div class="chips">${tchips}</div>
    <div class="dlist">${list}</div>`;
}
function setMF(id){fMem=id;renderDocs();}
function setTF(t){fType=t;renderDocs();}

// â”€â”€â”€ MEMBERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMembers(){
  document.getElementById('v-members').innerHTML=`
    <div class="sec-title">Family Members</div>
    ${V.members.map(m=>{const cnt=V.docs.filter(d=>d.memberId===m.id).length;return`<div class="mcard"><div class="mav">${m.name.charAt(0).toUpperCase()}</div><div style="flex:1"><div class="mname">${m.name}</div><div class="mrel">${m.relation}${m.dob?` Â· Born ${fmt(m.dob)}`:''}</div></div><div class="mcnt">${cnt} doc${cnt!==1?'s':''}</div></div>`;}).join('')}`;
}

// â”€â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSettings(){
  const lastSync=V.lastSync?new Date(V.lastSync).toLocaleString():'Never';
  document.getElementById('v-settings').innerHTML=`

    <div class="sec-title">ğŸ” Security</div>
    <div class="bcard" style="border-color:rgba(200,151,63,.25)">
      <div style="display:flex;gap:.75rem;align-items:center;margin-bottom:.75rem">
        <div style="width:42px;height:42px;border-radius:11px;background:var(--gold-d);display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0">ğŸ”</div>
        <div>
          <div style="font-weight:700;font-size:.95rem">Change PIN</div>
          <div style="font-size:.75rem;color:var(--text3)">Update your vault lock PIN</div>
        </div>
      </div>
      <button class="btn-f btn-prim" onclick="openChangePIN()" style="margin-bottom:.5rem">ğŸ” Change PIN</button>
      <p style="font-size:.75rem;color:var(--text3);margin:0">Forgot PIN? Lock the app â€” tap <strong style="color:var(--text2)">Forgot PIN?</strong> on the lock screen to reset via Google sign-in.</p>
    </div>

    <div class="sec-title">â˜ï¸ Google Drive</div>
    <div class="bcard">
      <h3>${gToken ? 'âœ… Connected to Google Drive' : 'â˜ï¸ Not Connected'}</h3>
      <p>${gToken
        ? 'Your documents are syncing to your personal Google Drive automatically. Each document type gets its own folder.'
        : 'Tap "Connect Drive" in the top bar to sign in with your Google account. Your files will sync to your own private Google Drive.'
      }</p>
      ${!gToken
        ? `<button class="btn-f btn-gdrive" onclick="gdriveAuth()">Sign in with Google Drive</button>`
        : `<button class="btn-f btn-sec" onclick="manualSync()">ğŸ”„ Sync All Now</button>`
      }
    </div>

    <div class="sec-title">ğŸ“ Drive Folder Structure</div>
    <div class="bcard">
      <p style="font-size:.8rem;color:var(--text2);margin-bottom:.75rem">Your files are organized automatically in Google Drive:</p>
      ${Object.entries(CAT_FOLDERS).map(([type,name])=>{
        const cnt=V.docs.filter(d=>d.type===type&&d.synced).length;
        const icon=TM[type]?.icon||'ğŸ“„';
        return `<div class="inforow"><span class="il">${icon} ${name}</span><span class="iv">${cnt} file${cnt!==1?'s':''} synced</span></div>`;
      }).join('')}
    </div>

    <div class="sec-title">Vault Status</div>
    <div class="bcard">
      <div class="inforow"><span class="il">Total Documents</span><span class="iv">${V.docs.length}</span></div>
      <div class="inforow"><span class="il">Files with Attachments</span><span class="iv">${V.docs.filter(d=>d.hasFile).length}</span></div>
      <div class="inforow"><span class="il">Synced to Drive</span><span class="iv">${V.docs.filter(d=>d.synced).length}</span></div>
      <div class="inforow"><span class="il">Last Sync</span><span class="iv">${lastSync}</span></div>
    </div>

    <div class="sec-title">Backup & Restore</div>
    <div class="bcard">
      <h3>ğŸ“¤ Export Metadata</h3>
      <p>Download all document info as a JSON file.</p>
      <button class="btn-f btn-prim" onclick="exportVault()">Download Vault JSON</button>
    </div>
    <div class="bcard">
      <h3>ğŸ“¥ Import / Restore</h3>
      <p>Restore from a previously exported JSON file.</p>
      <button class="btn-f btn-sec" onclick="document.getElementById('importInput').click()">Select Backup File</button>
    </div>
  `;
}

// saveCID no longer needed - Client ID is hardcoded

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DOC CRUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAddDoc(){
  editId=null;pendingFile=null;
  document.getElementById('dsTitle').textContent='Add Document';
  clearForm();populateMembers();populateTypeSelect();clearFileUI();
  os('docSheet');
}
function editDoc(id){
  const d=V.docs.find(x=>x.id===id);if(!d)return;
  editId=id;pendingFile=null;
  cs('viewSheet');
  document.getElementById('dsTitle').textContent='Edit Document';
  populateMembers(d.memberId);
  populateTypeSelect(d.type);
  document.getElementById('fName').value=d.name||'';
  document.getElementById('fNumber').value=d.number||'';
  document.getElementById('fExpiry').value=d.expiry||'';
  document.getElementById('fIssue').value=d.issue||'';
  document.getElementById('fIssuer').value=d.issuer||'';
  document.getElementById('fLocation').value=d.location||'';
  document.getElementById('fNotes').value=d.notes||'';
  document.getElementById('fTags').value=(d.tags||[]).join(', ');
  clearFileUI();
  if(d.hasFile){
    document.getElementById('filePreview').style.display='flex';
    document.getElementById('fpName').textContent=d.fileName||'Attached file';
    document.getElementById('fpSize').textContent=d.fileSize||'';
    document.getElementById('fpIco').textContent=fileIco(d.fileType||'');
  }
  setTimeout(()=>os('docSheet'),100);
}
async function saveDoc(){
  const name=document.getElementById('fName').value.trim();
  if(!name){alert('Document name is required.');return;}
  const doc={
    id:editId||uid(),
    memberId:document.getElementById('fMember').value,
    type:document.getElementById('fType').value,
    name,number:document.getElementById('fNumber').value.trim(),
    expiry:document.getElementById('fExpiry').value,
    issue:document.getElementById('fIssue').value,
    issuer:document.getElementById('fIssuer').value.trim(),
    location:document.getElementById('fLocation').value.trim(),
    notes:document.getElementById('fNotes').value.trim(),
    tags:document.getElementById('fTags').value.split(',').map(t=>t.trim()).filter(Boolean),
    updatedAt:new Date().toISOString(),
    hasFile:false,synced:false,
  };
  // preserve existing drive info if no new file
  if(editId){
    const old=V.docs.find(x=>x.id===editId)||{};
    if(!pendingFile&&old.hasFile){doc.hasFile=true;doc.fileName=old.fileName;doc.fileSize=old.fileSize;doc.fileType=old.fileType;doc.driveFileId=old.driveFileId;doc.driveLink=old.driveLink;doc.synced=old.synced;}
  }
  // handle new file
  if(pendingFile){
    doc.hasFile=true;doc.fileName=pendingFile.name;doc.fileSize=pendingFile.size;doc.fileType=pendingFile.type;
    await saveFile(doc.id,pendingFile);
  }
  if(editId){const i=V.docs.findIndex(x=>x.id===editId);V.docs[i]=doc;}
  else V.docs.push(doc);
  saveData();cs('docSheet');renderAll();
  // auto sync to Drive
  if(gToken&&doc.hasFile&&!doc.synced){
    toast('ğŸ”„ Uploading to Google Drive â†’ '+CAT_FOLDERS[doc.type||'other']+'â€¦');
    await autoSync(doc.id, pendingFile||await getFile(doc.id), doc.type);
    renderAll();
  } else if(gToken){
    autoSync();
  } else {
    toast('âœ… Document saved locally');
  }
}
async function deleteDoc(id){
  if(!confirm('Delete this document and its file? Cannot be undone.'))return;
  V.docs=V.docs.filter(x=>x.id!==id);
  await deleteFile(id);
  saveData();cs('viewSheet');renderAll();
  toast('ğŸ—‘ Document deleted');
}
async function viewDoc(id){
  const d=V.docs.find(x=>x.id===id);if(!d)return;
  const m=V.members.find(x=>x.id===d.memberId);
  const tm=TM[d.type]||TM.other;
  const today=new Date();today.setHours(0,0,0,0);
  const soon=new Date(today);soon.setDate(soon.getDate()+90);
  let expStr='â€”',expStyle='';
  if(d.expiry){const e=new Date(d.expiry);e.setHours(0,0,0,0);
    if(e<today){expStr=fmt(d.expiry)+' (EXPIRED)';expStyle='color:var(--rose)';}
    else if(e<=soon){const dy=Math.ceil((e-today)/86400000);expStr=`${fmt(d.expiry)} (${dy} days left)`;expStyle='color:var(--amber)';}
    else expStr=fmt(d.expiry);
  }
  const syncStatus=d.synced
    ?`<div class="sync-row"><span class="sr-ico">âœ…</span><div class="sr-text"><strong>Synced to Google Drive</strong><br>File is safely stored in your Drive</div>${d.driveLink?`<a href="${d.driveLink}" target="_blank" style="font-size:.72rem;color:var(--sky);white-space:nowrap">Open â†—</a>`:''}</div>`
    :(d.hasFile?`<div class="sync-row"><span class="sr-ico">â³</span><div class="sr-text"><strong>Not yet synced</strong><br>Connect Drive to upload</div><button onclick="manualSync()" style="font-size:.72rem;background:var(--gold-d);color:var(--gold2);border:1px solid rgba(200,151,63,.3);padding:.2rem .6rem;border-radius:6px;cursor:pointer;white-space:nowrap">Sync Now</button></div>`:'');
  const fileBtn=d.hasFile?`<button class="file-view-btn" onclick="openLocalFile('${d.id}')">ğŸ“ View Attached File â€” ${d.fileName||'file'}</button>`:'';
  document.getElementById('vsTitle').textContent=d.name;
  document.getElementById('vsBody').innerHTML=`
    <div class="vdoc-header"><div class="vdoc-icon">${tm.icon}</div><div><div class="vdoc-title">${d.name}</div><div class="vdoc-sub">${tm.label} Â· ${m?.name||'â€”'}</div></div></div>
    ${syncStatus}${fileBtn}
    <div>
      ${d.number?`<div class="dr"><span class="dl2">Document No.</span><span class="dv2 mono">${d.number}</span></div>`:''}
      ${d.expiry?`<div class="dr"><span class="dl2">Expiry</span><span class="dv2" style="${expStyle}">${expStr}</span></div>`:''}
      ${d.issue?`<div class="dr"><span class="dl2">Issue Date</span><span class="dv2">${fmt(d.issue)}</span></div>`:''}
      ${d.issuer?`<div class="dr"><span class="dl2">Issued By</span><span class="dv2">${d.issuer}</span></div>`:''}
      ${d.location?`<div class="dr"><span class="dl2">Location</span><span class="dv2">${d.location}</span></div>`:''}
      ${d.notes?`<div class="dr"><span class="dl2">Notes</span><span class="dv2">${d.notes}</span></div>`:''}
      ${d.tags?.length?`<div class="dr"><span class="dl2">Tags</span><span class="dv2">${d.tags.join(', ')}</span></div>`:''}
    </div>
    <div class="detail-acts">
      <button class="da-btn" onclick="editDoc('${d.id}')">âœï¸ Edit</button>
      <button class="da-btn da-del" onclick="deleteDoc('${d.id}')">ğŸ—‘ Delete</button>
    </div>`;
  os('viewSheet');
}
async function openLocalFile(docId){
  const f=await getFile(docId);
  if(!f){toast('File not found locally');return;}
  const bytes=atob(f.data);const arr=new Uint8Array(bytes.length);
  for(let i=0;i<bytes.length;i++)arr[i]=bytes.charCodeAt(i);
  const blob=new Blob([arr],{type:f.type});
  const url=URL.createObjectURL(blob);
  window.open(url,'_blank');
}

function clearForm(){
  ['fName','fNumber','fExpiry','fIssue','fIssuer','fLocation','fNotes','fTags'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('fType').value='id';
}
function populateMembers(sel){
  document.getElementById('fMember').innerHTML=V.members.map(m=>`<option value="${m.id}" ${m.id===sel?'selected':''}>${m.name}</option>`).join('');
  if(!sel&&fMem!=='all')document.getElementById('fMember').value=fMem;
}
function populateTypeSelect(selType){
  TM=getTM();
  const base=[
    ['id','ğŸªª Passport/ID'],['med','ğŸ¥ Medical'],['fin','ğŸ’° Financial'],
    ['legal','âš–ï¸ Legal'],['birth','ğŸ“œ Birth/Marriage'],['other','ğŸ“„ Other']
  ];
  const custom=(V.categories||[]).map(c=>[c.id,`${c.icon} ${c.label}`]);
  const all=[...base,...custom];
  document.getElementById('fType').innerHTML=all.map(([v,l])=>`<option value="${v}" ${v===selType?'selected':''}>${l}</option>`).join('');
}

// â”€â”€â”€ FILE HANDLING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fileIco(type){return type.includes('pdf')?'ğŸ“‹':type.includes('image')?'ğŸ–¼ï¸':'ğŸ“„';}
function handleFile(file){
  if(!file)return;
  if(file.size>10*1024*1024){toast('âš ï¸ File must be under 10 MB');return;}
  const reader=new FileReader();
  reader.onload=e=>{
    pendingFile={name:file.name,size:formatBytes(file.size),type:file.type,data:e.target.result.split(',')[1]};
    document.getElementById('filePreview').style.display='flex';
    document.getElementById('fpName').textContent=file.name;
    document.getElementById('fpSize').textContent=formatBytes(file.size);
    document.getElementById('fpIco').textContent=fileIco(file.type);
    document.getElementById('uploadZone').style.display='none';
    toast('ğŸ“ File attached: '+file.name);
  };
  reader.readAsDataURL(file);
}
function handleDrop(e){e.preventDefault();document.getElementById('uploadZone').classList.remove('drag');const f=e.dataTransfer.files[0];if(f)handleFile(f);}
function clearFile(){pendingFile=null;clearFileUI();}
function clearFileUI(){
  document.getElementById('fileInput').value='';
  document.getElementById('filePreview').style.display='none';
  document.getElementById('uploadZone').style.display='block';
}
function formatBytes(b){if(b<1024)return b+'B';if(b<1048576)return(b/1024).toFixed(1)+'KB';return(b/1048576).toFixed(1)+'MB';}

// â”€â”€â”€ MEMBER CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAddMember(){document.getElementById('mName').value='';document.getElementById('mDob').value='';os('memberSheet');}
function saveMember(){
  const name=document.getElementById('mName').value.trim();
  if(!name){alert('Name required.');return;}
  V.members.push({id:uid(),name,relation:document.getElementById('mRel').value,dob:document.getElementById('mDob').value});
  saveData();cs('memberSheet');renderAll();toast('ğŸ‘¤ Member added');
}

// â”€â”€â”€ EXPORT / IMPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportVault(){
  const blob=new Blob([JSON.stringify(V,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download=`family-vault-${new Date().toISOString().slice(0,10)}.json`;a.click();
  toast('ğŸ“¥ Vault exported');
}
function importVault(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{
    try{
      const data=JSON.parse(ev.target.result);
      if(!data.members||!data.docs){alert('Invalid vault file.');return;}
      if(!confirm(`Restore ${data.docs.length} docs for ${data.members.length} members? This replaces current data.`))return;
      V=data;saveData();renderAll();toast('âœ… Vault restored!');
    }catch{alert('Could not read file.');}
  };
  r.readAsText(f);e.target.value='';
}
function changePIN(){ openChangePIN(); }

// â”€â”€â”€ CATEGORY CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let selectedCatColor = '#4a9fd4';
function openAddCategory(){
  document.getElementById('catName').value='';
  document.getElementById('catIcon').value='ğŸ“„';
  selectedCatColor='#4a9fd4';

  // Build emoji picker via JS
  const emojis=['ğŸš—','ğŸ«','ğŸ›¡ï¸','âœˆï¸','ğŸ ','ğŸ’Š','ğŸ“','ğŸ¦','ğŸ“±','ğŸ”‘','âš¡','ğŸŒ','ğŸ‘¶','ğŸ¾','ğŸ‹ï¸','ğŸ“š','ğŸš€','ğŸ†','ğŸ“‹','ğŸ”’'];
  const ep=document.getElementById('emojiPicker');
  ep.innerHTML='';
  emojis.forEach(e=>{
    const btn=document.createElement('button');
    btn.type='button';
    btn.textContent=e;
    btn.style.cssText='width:38px;height:38px;font-size:1.3rem;background:var(--card);border:1px solid var(--border2);border-radius:8px;cursor:pointer';
    btn.onclick=()=>{ document.getElementById('catIcon').value=e; updateCatPreview(); };
    ep.appendChild(btn);
  });

  // Build color picker via JS
  const colors=['#4a9fd4','#38b2ac','#c8973f','#9f7aea','#48bb78','#e05252','#dd8c2f','#e84393','#20b2aa','#ff6b35'];
  const cp=document.getElementById('colorPicker');
  cp.innerHTML='';
  colors.forEach((c,i)=>{
    const btn=document.createElement('button');
    btn.type='button';
    btn.dataset.color=c;
    btn.style.cssText=`width:32px;height:32px;border-radius:50%;background:${c};cursor:pointer;transition:all .15s;border:${i===0?'3px solid white':'2px solid transparent'}`;
    btn.textContent=i===0?'âœ“':'';
    btn.onclick=()=>selectColor(c);
    cp.appendChild(btn);
  });

  updateCatPreview();
  os('catSheet');
}
function selectColor(c){
  selectedCatColor=c;
  document.querySelectorAll('#colorPicker button').forEach(b=>{
    b.textContent=b.dataset.color===c?'âœ“':'';
    b.style.border=b.dataset.color===c?'2px solid white':'2px solid transparent';
  });
  updateCatPreview();
}
function updateCatPreview(){
  const name=document.getElementById('catName')?.value||'New Category';
  const icon=document.getElementById('catIcon')?.value||'ğŸ“„';
  const el=document.getElementById('catPreviewIcon');
  const nl=document.getElementById('catPreviewName');
  if(el){el.textContent=icon;el.style.background=selectedCatColor+'26';}
  if(nl)nl.textContent=name||'New Category';
}
// Live preview updates
document.addEventListener('input',e=>{
  if(e.target.id==='catName'||e.target.id==='catIcon') updateCatPreview();
});
function saveCategory(){
  const name=document.getElementById('catName').value.trim();
  const icon=document.getElementById('catIcon').value.trim()||'ğŸ“„';
  if(!name){alert('Category name is required.');return;}
  if(!V.categories)V.categories=[];
  // Generate a unique id from name
  const id='cat_'+name.toLowerCase().replace(/[^a-z0-9]/g,'_').slice(0,20)+'_'+Date.now().toString(36);
  if(V.categories.find(c=>c.label.toLowerCase()===name.toLowerCase())){
    alert('A category with this name already exists.');return;
  }
  V.categories.push({id,label:name,icon,color:selectedCatColor});
  // Also add to CAT_FOLDERS for Drive sync
  CAT_FOLDERS[id]=name;
  saveData();cs('catSheet');renderAll();
  toast(`âœ… Category "${name}" added!`);
}
function deleteCategory(id){
  const cat=(V.categories||[]).find(c=>c.id===id);
  if(!cat)return;
  const cnt=V.docs.filter(d=>d.type===id).length;
  if(cnt>0){
    if(!confirm(`"${cat.label}" has ${cnt} document${cnt!==1?'s':''}. Delete category? Documents will move to "Other".`))return;
    V.docs.forEach(d=>{if(d.type===id)d.type='other';});
  } else {
    if(!confirm(`Delete category "${cat.label}"?`))return;
  }
  V.categories=(V.categories||[]).filter(c=>c.id!==id);
  delete CAT_FOLDERS[id];
  saveData();renderAll();
  toast(`ğŸ—‘ Category deleted`);
}

// â”€â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(d){if(!d)return'';const[y,m,day]=d.split('-');return`${day}/${m}/${y}`;}
function os(id){document.getElementById(id).classList.add('on');}
function cs(id){document.getElementById(id).classList.remove('on');}
document.querySelectorAll('.overlay').forEach(el=>el.addEventListener('click',e=>{if(e.target===el)el.classList.remove('on');}));
let toastT;
function toast(msg){const el=document.getElementById('toast');el.textContent=msg;el.classList.add('show');clearTimeout(toastT);toastT=setTimeout(()=>el.classList.remove('show'),3000);}

// â”€â”€â”€ PWA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if('serviceWorker' in navigator){window.addEventListener('load',()=>{navigator.serviceWorker.register('./sw.js').catch(()=>{});});}
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferInstall=e;});
window.addEventListener('appinstalled',()=>{deferInstall=null;toast('âœ… App installed!');});
window.addEventListener('load',handleOAuthCallback);
</script>
</body>
</html>
